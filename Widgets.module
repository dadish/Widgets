<?php

/**
 * 
 * Widgets - A ProcessWire module.
 * Helps to build responsive websites with ease.
 * 
 * @todo implement a save method that saves a widget into db
 * @todo create a widgets cache from WidgetsArray
 * @todo widgets module api should derive from $page->widgets or $template->widgets
 * @todo implement a `new()` method that returns a new widget with owner assigned. Consider all three types of owners
 * @todo implement a `css()` method that returns a css string for all involved widgets
 * @todo implement a `cssMin()` method that returns a minified css string of the `css()` method
 * @todo implement widget sorting capabilities
 */

require_once(__DIR__ . "/WidgetsArray.php");

class Widgets extends WireData implements Module {

  /**
   * Table created by this module
   *
   */
  const dbTableName = 'widgets';

  /**
   * A cache of widgets
   * 
   */
  protected $widgets;

  /**
   * Quick reference to database
   *
   */
  protected $database;

  /**
   * getModuleInfo is a module required by all modules to tell ProcessWire about them
   *
   * @return array
   *
   */
  public static function getModuleInfo() {
    return array(
      'title' => 'Widgets', 
      'version' => 001, 
      'summary' => __('Helps to build responsive websites with ease.'),
      'singular' => true, 
      'autoload' => true, 
      'icon' => 'cubes', 
      );
  }

  /**
   * Construct
   *
   */
  public function __construct() {
    parent::__construct();
    $this->database = wire('database');
    $this->widgets = new WidgetsArray();
  }

  /**
   * Initialize the module
   *
   */
  public function init() {
    $this->message('Widgets module is initialized!');
  }

  public function get($key)
  {
    $value = $this->widgets->get($key);
    if ($value instanceof Widget) return $value;
    $value = $this->fetch($key);
    if ($value instanceof Widget) return $value;
    return parent::get($key);
  }

  public function save(Widget $widget)
  {
    if (!$widget->isChanged()) return $widget;
    $table = self::dbTableName;
    $arr = $widget->getArray();
    $data = array(
      'renderPages' => $arr['renderPages'],
      'grid' => $arr['grid'],
      'options' => $arr['options'],
      'class' => $arr['class'],
      'className' => $widget->className()
      );
    if ($widget->isNew()) {
      $sql = "INSERT INTO $table (owner, ownerType, parent, data) VALUES(:owner, :ownerType, :parent, :data)";  
    } else {
      $sql = "UPDATE $table SET owner = :owner, ownerType = :ownerType, parent = :parent, data = :data WHERE id = :id";
    }
    $stmt = $this->datatbase->prepare($sql);
    $stmt->execute(array(
      ':owner' => $arr['owner'],
      ':ownerType' => $arr['ownerType'],
      ':parent' => $arr['parent'],
      ':data' => json_encode($data)
      ));
    $id = $this->database->lastInsertId();
    $widget->set('id', $id);
    $this->includeWidget($widget);
    return $widget;
  }

  public function fetch($key)
  {
    $table = self::dbTableName;
    if ($key instanceof Widget) $key = $this->getItemKey($key);
    $sql = "SELECT * FROM $table WHERE id = :id";
    $stmt = $this->database->prepare($sql);
    $stmt->execute(array(
      ':id' => $key
      ));
    if (!$stmt->rowCount()) return null;
    $data = $stmt->fetchAll(PDO::FETCH_ASSOC)[0];
    $data['data'] = json_decode($data['data'], true);
    $className = $data['data']['className'];
    $widget = $this->modules->get($className);
    $widget->setArray($data);
    $this->includeWidget($widget);
    return $widget;
  }

  protected function includeWidget(Widget $widget)
  {
    if ($widget->isNew()) return $this;
    if ($this->widgets->has($widget)) return $this;
    return $this->widgets->add($widget);
  }

  /**
   * Install sessions table
   *
   */
  public function ___install() {
    
    $table = self::dbTableName;

    $sql =   "CREATE TABLE $table (
      id INT UNSIGNED NOT NULL AUTO_INCREMENT,
      owner INT UNSIGNED NOT NULL,
      ownerType INT(1) NOT NULL,
      parent INT UNSIGNED NOT NULL DEFAULT 0,
      data TEXT,
      PRIMARY KEY (id), 
      INDEX (owner), 
      INDEX (ownerType), 
      INDEX (parent)
      ) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8";

    $this->database->query($sql); 
  }

  /**
   * Drop sessions table
   *
   */
  public function ___uninstall() {
    $this->database->query("DROP TABLE " . self::dbTableName); 
  }
}